<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Che Burlesque · Casting</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="theme-color" content="#8b1e3f">

<link rel="manifest" href="manifest.json">
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<style>
* {
  box-sizing: border-box;
  font-family: Arial, Helvetica, sans-serif;
}

body {
  margin: 0;
  background: #0e0e0e;
  color: #fff;
}

header {
  background: #8b1e3f;
  padding: 16px;
  text-align: center;
  font-size: 20px;
  font-weight: bold;
}

main {
  padding: 16px;
  max-width: 1300px;
  margin: auto;
}

.controls {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  margin-bottom: 20px;
}

button, input[type="file"] {
  padding: 10px 14px;
  border-radius: 6px;
  border: none;
  font-weight: bold;
  cursor: pointer;
}

button {
  background: #8b1e3f;
  color: #fff;
}

button.secondary {
  background: #444;
}

button.export {
  background: #2e7d32;
}

.grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
  gap: 16px;
}

.card {
  background: #1a1a1a;
  border-radius: 10px;
  padding: 14px;
  border: 1px solid #333;
}

.card h3 {
  margin-top: 0;
  color: #f2c4d8;
}

.card p {
  font-size: 14px;
  margin: 6px 0;
}

.label {
  color: #aaa;
  font-weight: bold;
}

select, textarea {
  width: 100%;
  padding: 6px;
  margin-top: 4px;
  background: #222;
  color: #fff;
  border: 1px solid #444;
  border-radius: 4px;
}

.video-link {
  color: #8ecdfc;
  word-break: break-all;
}
</style>
</head>

<body>
<header>Che Burlesque Producciones · Casting</header>

<main>

  <div class="controls">
    <input type="file" id="fileInput" accept=".csv,.xlsx">
    <button class="secondary" onclick="nuevoCasting()">Nuevo casting</button>
    <button class="export" onclick="exportar('Sigue')">Exportar SIGUE</button>
    <button class="export" onclick="exportar('Sigue con observaciones')">Exportar OBSERVACIONES</button>
    <button class="export" onclick="exportar('No sigue')">Exportar NO SIGUE</button>
  </div>

  <div id="cards" class="grid"></div>

</main>

<script>
let postulantes = [];

if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('service-worker.js');
}

document.getElementById('fileInput').addEventListener('change', handleFile);

function nuevoCasting() {
  if (!confirm('¿Eliminar todos los postulantes?')) return;
  postulantes = [];
  document.getElementById('cards').innerHTML = '';
}

function handleFile(e) {
  const file = e.target.files[0];
  if (!file) return;

  const reader = new FileReader();

  if (file.name.endsWith('.csv')) {
    reader.onload = evt => parseCSV(evt.target.result);
    reader.readAsText(file);
  } else {
    reader.onload = evt => parseXLSX(evt.target.result);
    reader.readAsArrayBuffer(file);
  }
}

function parseCSV(text) {
  const rows = text.split('\n').map(r => r.split(','));
  const headers = rows.shift();

  postulantes = rows.map(row => {
    let obj = {};
    headers.forEach((h, i) => obj[h.trim()] = row[i]?.trim());
    obj.estado = '';
    obj.observaciones = '';
    return obj;
  });

  renderCards();
}

function parseXLSX(buffer) {
  const wb = XLSX.read(buffer, { type: 'array' });
  const sheet = wb.Sheets[wb.SheetNames[0]];
  postulantes = XLSX.utils.sheet_to_json(sheet).map(p => ({
    ...p,
    estado: '',
    observaciones: ''
  }));
  renderCards();
}

function renderCards() {
  const container = document.getElementById('cards');
  container.innerHTML = '';

  postulantes.forEach((p, index) => {
    const card = document.createElement('div');
    card.className = 'card';

    let html = `<h3>${p.Nombre || p.nombre || 'Postulante'}</h3>`;

    Object.keys(p).forEach(key => {
      if (['estado', 'observaciones'].includes(key)) return;

      const value = p[key] || '-';
      if (value.startsWith('http')) {
        html += `<p><span class="label">${key}:</span><br>
        <a class="video-link" href="${value}" target="_blank">Ver video</a></p>`;
      } else {
        html += `<p><span class="label">${key}:</span><br>${value}</p>`;
      }
    });

    html += `
      <p class="label">Decisión</p>
      <select onchange="setEstado(${index}, this.value)">
        <option value="">Seleccionar</option>
        <option>Sigue</option>
        <option>Sigue con observaciones</option>
        <option>No sigue</option>
      </select>

      <p class="label">Observaciones internas</p>
      <textarea rows="3" oninput="setObs(${index}, this.value)"></textarea>
    `;

    card.innerHTML = html;
    container.appendChild(card);
  });
}

function setEstado(i, value) {
  postulantes[i].estado = value;
}

function setObs(i, value) {
  postulantes[i].observaciones = value;
}

function exportar(tipo) {
  const filtrados = postulantes.filter(p => p.estado === tipo);
  if (filtrados.length === 0) {
    alert('No hay postulantes en esta categoría');
    return;
  }

  const ws = XLSX.utils.json_to_sheet(filtrados);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, tipo);
  XLSX.writeFile(wb, `Casting_${tipo}.xlsx`);
}
</script>

</body>
</html>
