<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Teleprompter</title>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<style>
body {
  background: black;
  color: white;
  font-family: Arial, sans-serif;
}
#panel {
  position: fixed;
  left: 0;
  top: 0;
  width: 260px;
  background: #111;
  height: 100%;
  padding: 10px;
  overflow-y: auto;
}
.name {
  font-weight: bold;
  margin: 6px 0;
}
#prompter {
  margin-left: 280px;
  font-size: 32px;
  line-height: 1.6;
}
</style>
</head>

<body>

<div id="panel">
  <input type="file" id="fileInput"><br><br>
  <label>Velocidad:</label>
  <input type="number" id="speed" value="1"><br><br>
  <label>Tamaño texto:</label>
  <input type="number" id="fontSize" value="32">
  <div id="names"></div>
</div>

<div id="prompter"></div>

<script>
let participants = JSON.parse(localStorage.getItem("participants")) || [];
let textContent = localStorage.getItem("textContent") || "";

const prompter = document.getElementById("prompter");
const namesDiv = document.getElementById("names");
const speedInput = document.getElementById("speed");
const fontSizeInput = document.getElementById("fontSize");

prompter.innerText = textContent;
prompter.style.fontSize = fontSizeInput.value + "px";

/* ------------------ VALIDACIÓN DE NOMBRE ------------------ */
function isValidName(value) {
  if (!value) return false;
  const v = value.toString().trim();
  if (v.length < 2 || v.length > 40) return false;
  if (/http|www|\.com|@|\//i.test(v)) return false;
  return true;
}

/* ------------------ IMPORTAR XLSX ------------------ */
document.getElementById("fileInput").addEventListener("change", e => {
  const file = e.target.files[0];
  const reader = new FileReader();

  reader.onload = evt => {
    const workbook = XLSX.read(evt.target.result, { type: "binary" });
    const sheet = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);

    participants = sheet.map(row => {
      const artistic =
        row["nombre artístico"] ||
        row["nombre_artistico"] ||
        row["artistico"];

      const real =
        row["nombre real"] ||
        row["nombre"];

      let finalName = "Sin nombre";

      if (isValidName(artistic)) finalName = artistic;
      else if (isValidName(real)) finalName = real;

      return { name: finalName };
    });

    saveData();
    renderNames();
  };

  reader.readAsBinaryString(file);
});

/* ------------------ RENDER NOMBRES ------------------ */
function renderNames() {
  namesDiv.innerHTML = "";
  participants.forEach(p => {
    const div = document.createElement("div");
    div.className = "name";
    div.textContent = p.name;
    namesDiv.appendChild(div);
  });
}

/* ------------------ GUARDADO ------------------ */
function saveData() {
  localStorage.setItem("participants", JSON.stringify(participants));
  localStorage.setItem("textContent", prompter.innerText);
  localStorage.setItem("speed", speedInput.value);
  localStorage.setItem("fontSize", fontSizeInput.value);
}

/* ------------------ CONTROLES ------------------ */
speedInput.value = localStorage.getItem("speed") || 1;
fontSizeInput.value = localStorage.getItem("fontSize") || 32;

fontSizeInput.addEventListener("input", () => {
  prompter.style.fontSize = fontSizeInput.value + "px";
  saveData();
});

/* ------------------ SCROLL ------------------ */
let scrollPos = 0;
setInterval(() => {
  scrollPos += parseFloat(speedInput.value);
  window.scrollTo(0, scrollPos);
}, 50);

/* ------------------ INIT ------------------ */
renderNames();
</script>

</body>
</html>
